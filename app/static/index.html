<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Downloader API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script defer src="https://umami.sametcc.me/script.js" data-website-id="9d5c9bc2-f978-414d-918d-dd6638ae7312"></script>
    <style>
        body {
            background: #121212;
            min-height: 100vh;
            color: #e0e0e0;
        }
        
        .navbar {
            background: #1a1a1a;
            border-bottom: 1px solid #2d2d2d;
        }
        
        .card {
            background: #1e1e1e;
            border: 1px solid #2d2d2d;
            border-radius: 8px;
        }
        
        .btn-primary {
            background: #ffffff;
            border-color: #ffffff;
            color: #121212;
        }
        
        .btn-primary:hover {
            background: #e0e0e0;
            border-color: #e0e0e0;
            color: #121212;
        }
        
        .btn-primary:disabled {
            background: #4a4a4a;
            border-color: #4a4a4a;
            color: #888;
        }
        
        .feature-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 12px;
            background: #2d2d2d;
            color: #e0e0e0;
        }
        
        .result-card {
            display: none;
        }
        
        .result-card.show {
            display: block;
        }
        
        .loading-spinner {
            display: none;
        }
        
        .loading-spinner.show {
            display: inline-block;
        }
        
        .profile-pic-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #3d3d3d;
        }
        
        .stat-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 4px;
            background: #2d2d2d;
            margin: 4px;
            font-size: 13px;
            color: #e0e0e0;
        }
        
        #profileBio {
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        /* Posts Grid */
        .posts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        @media (max-width: 768px) {
            .posts-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .post-item {
            position: relative;
            aspect-ratio: 1;
            overflow: hidden;
            border-radius: 4px;
            background: #2d2d2d;
            cursor: pointer;
        }
        
        .post-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.2s ease;
        }
        
        .post-item:hover img {
            transform: scale(1.05);
        }
        
        .post-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .post-item:hover .post-overlay {
            opacity: 1;
        }
        
        .post-stats {
            display: flex;
            gap: 15px;
            color: #fff;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .post-stats span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .post-download-btn {
            background: #fff;
            color: #121212;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.2s;
        }
        
        .post-download-btn:hover {
            background: #e0e0e0;
        }
        
        .post-type-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            color: #fff;
            font-size: 16px;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
        }
        
        .posts-section {
            margin-top: 20px;
        }
        
        .posts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .load-more-btn {
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            color: #e0e0e0;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            transition: background 0.2s;
        }
        
        .load-more-btn:hover {
            background: #3d3d3d;
        }
        
        .load-more-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .nav-tabs {
            border-bottom: 1px solid #2d2d2d;
        }
        
        .nav-tabs .nav-link {
            color: #888;
            border: none;
        }
        
        .nav-tabs .nav-link:hover {
            color: #e0e0e0;
            border: none;
        }
        
        .nav-tabs .nav-link.active {
            color: #fff;
            font-weight: 500;
            background: transparent;
            border: none;
            border-bottom: 2px solid #fff;
        }
        
        .form-control, .input-group-text {
            background: #2d2d2d;
            border-color: #3d3d3d;
            color: #e0e0e0;
        }
        
        .form-control:focus {
            background: #2d2d2d;
            border-color: #555;
            color: #e0e0e0;
            box-shadow: none;
        }
        
        .form-control::placeholder {
            color: #666;
        }
        
        .text-muted {
            color: #888 !important;
        }
        
        .alert-secondary {
            background: #2d2d2d;
            border-color: #3d3d3d;
            color: #e0e0e0;
        }
        
        .alert-warning {
            background: #3d3000;
            border-color: #554400;
            color: #ffcc00;
        }
        
        .alert-success {
            background: #003d00;
            border-color: #005500;
            color: #00ff00;
        }
        
        .alert-danger {
            background: #3d0000;
            border-color: #550000;
            color: #ff6666;
        }
        
        .alert-info {
            background: #002d3d;
            border-color: #004455;
            color: #66ccff;
        }
        
        code {
            background: #2d2d2d;
            color: #e0e0e0;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .form-check-input {
            background-color: #2d2d2d;
            border-color: #3d3d3d;
        }
        
        .form-check-input:checked {
            background-color: #fff;
            border-color: #fff;
        }
        
        .badge-hidden {
            display: none;
        }
        
        .badge-visible {
            display: inline-block;
        }
        
        .profile-pic-preview {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .profile-pic-preview:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }
        
        /* Fullscreen Image Modal */
        .fullscreen-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .fullscreen-modal.show {
            display: flex;
        }
        
        .fullscreen-image-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        
        .fullscreen-image-container.dragging {
            cursor: grabbing;
        }
        
        .fullscreen-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            transition: transform 0.1s ease-out;
            transform-origin: center center;
            -webkit-user-drag: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 40px;
            color: #fff;
            cursor: pointer;
            z-index: 10000;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .fullscreen-close:hover {
            opacity: 1;
        }
        
        .zoom-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 15px;
            border-radius: 30px;
        }
        
        .zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .zoom-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .zoom-level {
            color: #fff;
            font-size: 14px;
            min-width: 50px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .zoom-hint {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            z-index: 10000;
        }
    </style>
</head>
<body>
    <!-- Fullscreen Image Modal -->
    <div class="fullscreen-modal" id="fullscreenModal">
        <span class="fullscreen-close" onclick="closeFullscreen()">&times;</span>
        <div class="fullscreen-image-container" id="imageContainer">
            <img src="" alt="Full size profile picture" id="fullscreenImage">
        </div>
        <div class="zoom-hint">Scroll to zoom • Drag to pan • Double-click to reset</div>
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">
                <i class="bi bi-dash-lg"></i>
            </button>
            <span class="zoom-level" id="zoomLevel">100%</span>
            <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">
                <i class="bi bi-plus-lg"></i>
            </button>
            <button class="zoom-btn" onclick="resetZoom()" title="Reset">
                <i class="bi bi-arrow-counterclockwise"></i>
            </button>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <a class="navbar-brand text-white" href="#">
                <i class="bi bi-instagram me-2"></i>Instagram Downloader
            </a>
            <div class="navbar-nav flex-row">
                <a class="nav-link text-secondary me-3" href="/docs" target="_blank" rel="noopener">
                    <i class="bi bi-file-code me-1"></i>
                </a>
                <a class="nav-link text-secondary" href="https://github.com/sametcn99/instaloader-api" target="_blank" rel="noopener">
                    <i class="bi bi-github me-1"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-4">
        <!-- Header -->
        <div class="text-center mb-4">
            <h4 class="mb-2">Download Instagram Content</h4>
            <p class="text-muted small">Download posts and profile pictures</p>
        </div>

        <!-- Main Card -->
        <div class="row justify-content-center">
            <div class="col-lg-9">
                <div class="card">
                    <div class="card-body p-0">
                        <!-- Tabs -->
                        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="username-tab" data-bs-toggle="tab" data-bs-target="#username-content" type="button" role="tab" aria-controls="username-content" aria-selected="true">
                                    <i class="bi bi-person me-1"></i>By Username
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="link-tab" data-bs-toggle="tab" data-bs-target="#link-content" type="button" role="tab" aria-controls="link-content" aria-selected="false">
                                    <i class="bi bi-link-45deg me-1"></i>By Post Link
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content p-4">
                            <!-- Username Tab -->
                            <div class="tab-pane fade show active" id="username-content" role="tabpanel">
                                <!-- Username Input -->
                                <div class="input-group mb-4">
                                    <span class="input-group-text">@</span>
                                    <input type="text" class="form-control" id="username" 
                                           placeholder="Enter Instagram username" autocomplete="off">
                                    <button class="btn btn-primary" type="button" id="getProfileBtn">
                                        <span class="loading-spinner spinner-border spinner-border-sm me-1" id="profileSpinner"></span>
                                        <span id="searchIcon"><i class="bi bi-search me-1"></i></span>
                                        Get Profile
                                    </button>
                                </div>

                                <!-- Profile Info Card -->
                                <div class="card result-card mb-4" id="profileCard">
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <div class="col-md-3 text-center mb-3 mb-md-0">
                                                <img src="" alt="Profile" class="profile-pic-preview mb-2" id="profilePic" 
                                                     onclick="openFullscreen(this.src)" title="Click to view full size">
                                                <div><strong id="profileUsername"></strong></div>
                                                <small class="text-muted" id="profileFullname"></small>
                                            </div>
                                            <div class="col-md-9">
                                                <p class="mb-2 small" id="profileBio"></p>
                                                <div>
                                                    <span class="stat-badge"><i class="bi bi-people me-1"></i><span id="followers">0</span> followers</span>
                                                    <span class="stat-badge"><i class="bi bi-person-plus me-1"></i><span id="following">0</span> following</span>
                                                    <span class="stat-badge"><i class="bi bi-grid me-1"></i><span id="postCount">0</span> posts</span>
                                                    <span class="stat-badge badge-hidden" id="verifiedBadge"><i class="bi bi-patch-check-fill text-primary"></i> Verified</span>
                                                    <span class="stat-badge badge-hidden" id="privateBadge"><i class="bi bi-lock"></i> Private</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Download Options -->
                                <div class="result-card" id="downloadOptions">
                                    <h6 class="mb-3"><i class="bi bi-download me-2"></i>Download Options</h6>
                                    
                                    <div class="row g-3">
                                        <!-- Download All -->
                                        <div class="col-md-6">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <div class="feature-icon mx-auto">
                                                        <i class="bi bi-collection"></i>
                                                    </div>
                                                    <h6>All Content</h6>
                                                    <p class="text-muted small mb-2">Posts & profile picture</p>
                                                    <div class="mb-2">
                                                        <input type="number" class="form-control form-control-sm" 
                                                               id="maxPostsAll" placeholder="Max posts (optional)" min="1" max="1000">
                                                    </div>
                                                    <button class="btn btn-primary btn-sm w-100" onclick="downloadAll()">
                                                        <span class="spinner-border spinner-border-sm me-1 d-none" id="spinnerAll"></span>
                                                        <i class="bi bi-download me-1"></i>Download All
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Download Posts -->
                                        <div class="col-md-6">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <div class="feature-icon mx-auto">
                                                        <i class="bi bi-grid-3x3"></i>
                                                    </div>
                                                    <h6>Posts Only</h6>
                                                    <p class="text-muted small mb-2">Photos and videos</p>
                                                    <div class="mb-2">
                                                        <input type="number" class="form-control form-control-sm" 
                                                               id="maxPostsPosts" placeholder="Max posts (optional)" min="1" max="1000">
                                                    </div>
                                                    <button class="btn btn-primary btn-sm w-100" onclick="downloadPosts()">
                                                        <span class="spinner-border spinner-border-sm me-1 d-none" id="spinnerPosts"></span>
                                                        <i class="bi bi-download me-1"></i>Download Posts
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Download Profile Pic -->
                                        <div class="col-md-6">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <div class="feature-icon mx-auto">
                                                        <i class="bi bi-person-circle"></i>
                                                    </div>
                                                    <h6>Profile Picture</h6>
                                                    <p class="text-muted small mb-2">Full resolution photo</p>
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="urlOnly">
                                                        <label class="form-check-label small" for="urlOnly">Get URL only</label>
                                                    </div>
                                                    <button class="btn btn-primary btn-sm w-100" onclick="downloadProfilePic()">
                                                        <span class="spinner-border spinner-border-sm me-1 d-none" id="spinnerPic"></span>
                                                        <i class="bi bi-download me-1"></i>Download
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Posts Grid Section -->
                                <div class="result-card posts-section" id="postsSection">
                                    <div class="posts-header">
                                        <h6 class="mb-0"><i class="bi bi-grid-3x3 me-2"></i>Recent Posts</h6>
                                        <small class="text-muted"><span id="loadedPostsCount">0</span> / <span id="totalPostsCount">0</span> posts</small>
                                    </div>
                                    <div class="posts-grid" id="postsGrid">
                                        <!-- Posts will be loaded here -->
                                    </div>
                                    <button class="load-more-btn" id="loadMoreBtn" onclick="loadMorePosts()" style="display: none;">
                                        <span class="spinner-border spinner-border-sm me-2 d-none" id="loadMoreSpinner"></span>
                                        Load More Posts
                                    </button>
                                </div>
                            </div>

                            <!-- Post Link Tab -->
                            <div class="tab-pane fade" id="link-content" role="tabpanel">
                                <div class="mb-4">
                                    <h6>Download by Post Link</h6>
                                    <p class="text-muted small">Paste an Instagram post URL or shortcode</p>
                                </div>

                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="postUrl" 
                                           placeholder="https://www.instagram.com/p/ABC123/ or shortcode">
                                    <button class="btn btn-primary" type="button" onclick="downloadByLink()">
                                        <span class="spinner-border spinner-border-sm me-1 d-none" id="spinnerLink"></span>
                                        <i class="bi bi-download me-1"></i>Download
                                    </button>
                                </div>

                                <div class="alert alert-secondary small">
                                    <strong>Supported formats:</strong>
                                    <ul class="mb-0 mt-1">
                                        <li>Full URL: <code>https://www.instagram.com/p/ABC123xyz/</code></li>
                                        <li>Short URL: <code>https://instagr.am/p/ABC123xyz/</code></li>
                                        <li>Shortcode: <code>ABC123xyz</code></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Messages -->
                <div class="mt-3" id="statusContainer"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = window.location.origin;
        let currentUsername = '';
        let loadedPosts = [];
        let totalPostCount = 0;
        let postsPerLoad = 12;

        // Extract username from Instagram URL
        function extractUsername(input) {
            input = input.trim();
            
            // Remove @ if present at the start
            if (input.startsWith('@')) {
                return input.substring(1);
            }
            
            // Check if it's an Instagram URL
            const urlPatterns = [
                /(?:https?:\/\/)?(?:www\.)?instagram\.com\/([a-zA-Z0-9._]+)\/?(?:\?.*)?$/,
                /(?:https?:\/\/)?(?:www\.)?instagr\.am\/([a-zA-Z0-9._]+)\/?(?:\?.*)?$/
            ];
            
            for (const pattern of urlPatterns) {
                const match = input.match(pattern);
                if (match && match[1]) {
                    // Exclude reserved paths
                    const reserved = ['p', 'reel', 'reels', 'stories', 'explore', 'accounts', 'direct', 'tv'];
                    if (!reserved.includes(match[1].toLowerCase())) {
                        return match[1];
                    }
                }
            }
            
            // Return as-is if no URL pattern matched (assume it's a username)
            return input;
        }

        // Zoom state
        let currentZoom = 1;
        let translateX = 0;
        let translateY = 0;
        let isDragging = false;
        let startX = 0;
        let startY = 0;

        // Fullscreen modal functions
        function openFullscreen(src) {
            const modal = document.getElementById('fullscreenModal');
            const img = document.getElementById('fullscreenImage');
            img.src = src;
            resetZoom();
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeFullscreen() {
            const modal = document.getElementById('fullscreenModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
            resetZoom();
        }

        function updateTransform() {
            const img = document.getElementById('fullscreenImage');
            img.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
        }

        function zoomIn() {
            if (currentZoom < 5) {
                currentZoom = Math.min(5, currentZoom + 0.25);
                updateTransform();
            }
        }

        function zoomOut() {
            if (currentZoom > 0.25) {
                currentZoom = Math.max(0.25, currentZoom - 0.25);
                // Constrain pan when zooming out
                if (currentZoom <= 1) {
                    translateX = 0;
                    translateY = 0;
                }
                updateTransform();
            }
        }

        function resetZoom() {
            currentZoom = 1;
            translateX = 0;
            translateY = 0;
            updateTransform();
        }

        // Mouse wheel zoom
        document.getElementById('fullscreenModal').addEventListener('wheel', (e) => {
            e.preventDefault();
            if (e.deltaY < 0) {
                zoomIn();
            } else {
                zoomOut();
            }
        }, { passive: false });

        // Drag to pan
        const imageContainer = document.getElementById('imageContainer');
        
        imageContainer.addEventListener('mousedown', (e) => {
            if (e.target.tagName === 'IMG' && currentZoom > 1) {
                isDragging = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                imageContainer.classList.add('dragging');
                e.preventDefault();
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                updateTransform();
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            imageContainer.classList.remove('dragging');
        });

        // Double-click to reset
        imageContainer.addEventListener('dblclick', (e) => {
            if (e.target.tagName === 'IMG') {
                resetZoom();
            }
        });

        // Click outside image to close
        imageContainer.addEventListener('click', (e) => {
            if (e.target === imageContainer && !isDragging) {
                closeFullscreen();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeFullscreen();
            }
            // Keyboard shortcuts for zoom
            const modal = document.getElementById('fullscreenModal');
            if (modal.classList.contains('show')) {
                if (e.key === '+' || e.key === '=') {
                    zoomIn();
                } else if (e.key === '-') {
                    zoomOut();
                } else if (e.key === '0') {
                    resetZoom();
                }
            }
        });

        // Get Profile Info
        document.getElementById('getProfileBtn').addEventListener('click', getProfile);
        document.getElementById('username').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') getProfile();
        });
        
        // Auto-extract username when pasting
        document.getElementById('username').addEventListener('paste', (e) => {
            setTimeout(() => {
                const input = document.getElementById('username');
                const extracted = extractUsername(input.value);
                if (extracted !== input.value) {
                    input.value = extracted;
                    showStatus(`Username extracted: @${extracted}`, 'info');
                }
            }, 0);
        });

        async function getProfile() {
            const rawInput = document.getElementById('username').value;
            const username = extractUsername(rawInput);
            
            if (!username) {
                showStatus('Please enter a username or Instagram profile URL', 'warning');
                return;
            }
            
            // Update input field with extracted username
            document.getElementById('username').value = username;

            currentUsername = username;
            const btn = document.getElementById('getProfileBtn');
            const spinner = document.getElementById('profileSpinner');
            const icon = document.getElementById('searchIcon');
            
            btn.disabled = true;
            spinner.classList.add('show');
            icon.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/profile/${username}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || data.error || 'Failed to fetch profile');
                }

                // Update profile card
                document.getElementById('profilePic').src = `${API_BASE}/download/profile-pic/${data.username}?url_only=false`;
                document.getElementById('profileUsername').textContent = '@' + data.username;
                document.getElementById('profileFullname').textContent = data.full_name || '';
                document.getElementById('profileBio').textContent = data.biography || 'No bio';  // pre-wrap CSS preserves line breaks
                document.getElementById('followers').textContent = formatNumber(data.followers);
                document.getElementById('following').textContent = formatNumber(data.following);
                document.getElementById('postCount').textContent = formatNumber(data.post_count);
                
                document.getElementById('verifiedBadge').className = data.is_verified ? 'stat-badge badge-visible' : 'stat-badge badge-hidden';
                document.getElementById('privateBadge').className = data.is_private ? 'stat-badge badge-visible' : 'stat-badge badge-hidden';

                // Show cards
                document.getElementById('profileCard').classList.add('show');
                document.getElementById('downloadOptions').classList.add('show');
                
                // Store total post count and load posts if not private
                totalPostCount = data.post_count;
                document.getElementById('totalPostsCount').textContent = data.post_count;
                
                if (!data.is_private && data.post_count > 0) {
                    document.getElementById('postsSection').classList.add('show');
                    loadedPosts = [];
                    document.getElementById('postsGrid').innerHTML = '';
                    await loadPosts();
                } else {
                    document.getElementById('postsSection').classList.remove('show');
                }
                
                showStatus('Profile loaded successfully!', 'success');

            } catch (error) {
                showStatus(error.message, 'danger');
                document.getElementById('profileCard').classList.remove('show');
                document.getElementById('downloadOptions').classList.remove('show');
                document.getElementById('postsSection').classList.remove('show');
            } finally {
                btn.disabled = false;
                spinner.classList.remove('show');
                icon.style.display = 'inline';
            }
        }

        // Load posts from API
        async function loadPosts() {
            try {
                const response = await fetch(`${API_BASE}/profile/${currentUsername}/posts?max_posts=${postsPerLoad}`);
                const data = await response.json();
                
                if (!response.ok) {
                    console.error('Failed to load posts:', data.detail);
                    return;
                }
                
                loadedPosts = data.posts;
                renderPosts(data.posts);
                document.getElementById('loadedPostsCount').textContent = loadedPosts.length;
                
                // Show/hide load more button (API currently returns max 50 at once)
                if (loadedPosts.length < totalPostCount && loadedPosts.length < 50) {
                    document.getElementById('loadMoreBtn').style.display = 'block';
                } else {
                    document.getElementById('loadMoreBtn').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error loading posts:', error);
            }
        }
        
        async function loadMorePosts() {
            const btn = document.getElementById('loadMoreBtn');
            const spinner = document.getElementById('loadMoreSpinner');
            
            btn.disabled = true;
            spinner.classList.remove('d-none');
            
            try {
                const newMax = Math.min(loadedPosts.length + postsPerLoad, 50);
                const response = await fetch(`${API_BASE}/profile/${currentUsername}/posts?max_posts=${newMax}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to load more posts');
                }
                
                // Get only new posts
                const newPosts = data.posts.slice(loadedPosts.length);
                loadedPosts = data.posts;
                renderPosts(newPosts, true);
                document.getElementById('loadedPostsCount').textContent = loadedPosts.length;
                
                // Hide button if we've loaded all or reached max
                if (loadedPosts.length >= totalPostCount || loadedPosts.length >= 50) {
                    btn.style.display = 'none';
                }
                
            } catch (error) {
                showStatus(error.message, 'danger');
            } finally {
                btn.disabled = false;
                spinner.classList.add('d-none');
            }
        }
        
        function getThumbnailSrc(url) {
            return `${API_BASE}/proxy/thumbnail?url=${encodeURIComponent(url)}`;
        }

        function renderPosts(posts, append = false) {
            const grid = document.getElementById('postsGrid');
            if (!append) {
                grid.innerHTML = '';
            }
            
            posts.forEach(post => {
                const postEl = document.createElement('div');
                postEl.className = 'post-item';
                postEl.innerHTML = `
                    <img src="${getThumbnailSrc(post.thumbnail_url)}" alt="Post" loading="lazy" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%232d2d2d%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23666%22 font-size=%2212%22>No image</text></svg>'">
                    ${post.is_video ? '<span class="post-type-badge"><i class="bi bi-play-circle-fill"></i></span>' : ''}
                    <div class="post-overlay">
                        <div class="post-stats">
                            <span><i class="bi bi-heart-fill"></i> ${formatNumber(post.likes)}</span>
                            <span><i class="bi bi-chat-fill"></i> ${formatNumber(post.comments)}</span>
                        </div>
                        <button class="post-download-btn" onclick="event.stopPropagation(); downloadSinglePost('${post.shortcode}', this)">
                            <i class="bi bi-download"></i> Download
                        </button>
                    </div>
                `;
                
                // Click to open in new tab
                postEl.addEventListener('click', () => {
                    window.open(post.post_url, '_blank');
                });
                
                // Click on image to view fullscreen
                const img = postEl.querySelector('img');
                img.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openFullscreen(getThumbnailSrc(post.thumbnail_url));
                });
                
                grid.appendChild(postEl);
            });
        }
        
        async function downloadSinglePost(shortcode, btn) {
            const url = `${API_BASE}/download/post?url=${encodeURIComponent(shortcode)}`;
            const originalHtml = btn ? btn.innerHTML : '';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Preparing...';
            }
            try {
                await downloadFile(url, null, `${shortcode}`);
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml || '<i class="bi bi-download"></i> Download';
                }
            }
        }

        // Download functions
        async function downloadAll() {
            const maxPosts = document.getElementById('maxPostsAll').value;
            let url = `${API_BASE}/download/all/${currentUsername}`;
            if (maxPosts) url += `?max_posts=${maxPosts}`;
            await downloadFile(url, 'spinnerAll', `${currentUsername}.zip`);
        }

        async function downloadPosts() {
            const maxPosts = document.getElementById('maxPostsPosts').value;
            let url = `${API_BASE}/download/posts/${currentUsername}`;
            if (maxPosts) url += `?max_posts=${maxPosts}`;
            await downloadFile(url, 'spinnerPosts', `${currentUsername}_posts.zip`);
        }

        async function downloadProfilePic() {
            const urlOnly = document.getElementById('urlOnly').checked;
            const url = `${API_BASE}/download/profile-pic/${currentUsername}?url_only=${urlOnly}`;
            
            if (urlOnly) {
                const spinner = document.getElementById('spinnerPic');
                spinner.classList.remove('d-none');
                
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.detail || 'Failed to get profile picture URL');
                    }
                    
                    // Copy URL to clipboard
                    await navigator.clipboard.writeText(data.profile_pic_url);
                    showStatus('Profile picture URL copied to clipboard!', 'success');
                    
                } catch (error) {
                    showStatus(error.message, 'danger');
                } finally {
                    spinner.classList.add('d-none');
                }
            } else {
                await downloadFile(url, 'spinnerPic', `${currentUsername}_profile_pic.jpg`);
            }
        }

        async function downloadByLink() {
            const postUrl = document.getElementById('postUrl').value.trim();
            if (!postUrl) {
                showStatus('Please enter a post URL or shortcode', 'warning');
                return;
            }

            const url = `${API_BASE}/download/post?url=${encodeURIComponent(postUrl)}`;
            await downloadFile(url, 'spinnerLink', 'instagram_post');
        }

        async function downloadFile(url, spinnerId, defaultFilename) {
            const spinner = spinnerId ? document.getElementById(spinnerId) : null;
            if (spinner) spinner.classList.remove('d-none');
            showStatus('Downloading... This may take a while for large accounts.', 'info');

            try {
                const response = await fetch(url);
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || data.error || 'Download failed');
                }

                // Get filename from Content-Disposition header or use default
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = defaultFilename;
                if (contentDisposition) {
                    const match = contentDisposition.match(/filename="?([^";\n]+)"?/);
                    if (match) filename = match[1];
                }

                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
                a.remove();

                showStatus('Download completed!', 'success');

            } catch (error) {
                showStatus(error.message, 'danger');
            } finally {
                if (spinner) spinner.classList.add('d-none');
            }
        }

        function showStatus(message, type) {
            const container = document.getElementById('statusContainer');
            const icons = {
                success: 'check-circle',
                danger: 'exclamation-triangle',
                warning: 'exclamation-circle',
                info: 'info-circle'
            };
            
            container.innerHTML = `
                <div class="alert alert-${type} alert-custom alert-dismissible fade show" role="alert">
                    <i class="bi bi-${icons[type]} me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            // Auto-dismiss success messages
            if (type === 'success') {
                setTimeout(() => {
                    const alert = container.querySelector('.alert');
                    if (alert) alert.remove();
                }, 5000);
            }
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }
    </script>
</body>
</html>
